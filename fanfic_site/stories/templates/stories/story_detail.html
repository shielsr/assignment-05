{% extends "stories/base.html" %}
{% load static %}
{% block content %}


<article class="media content-section">

    <div class="media-body">

        <h1>{{ object.title }}</h1>
        <h5>A {{ object.genre }} story by <a class="mr-2" href="{% url 'user-stories' story.author.username %}">{{ object.author }}</a>
        </h5>
        {% if object.get_cover_image_url %}
        <p><img src="{{ object.get_cover_image_url }}" alt="{{ object.title }} cover" style="max-width:200px;">
        </p>
        {% endif %}
        {% if object.author == user %}

        <div class="alert alert-warning mt-4">
            <h4>Status: {{ object.get_status_display }}</h4>
            <form method="post" action="{% url 'story-toggle' object.pk %}">
                {% csrf_token %}
                {% if object.status == 'draft' %}
                <button class="btn btn-lg btn-success">Publish Story</button>
                {% elif object.status == 'published' %}
                <button class="btn btn-lg btn-secondary">Unpublish Story</button>
                {% endif %}
            </form>
        </div>

        {% endif %}


        <h2>Chapters</h2>

        {% if request.user == story.author and object.chapters.all %}
        <p class="text-muted small">Drag and drop to reorder chapters</p>
        {% endif %}

        <ul id="chapter-list" data-story-id="{{ object.id }}" style="list-style: none; padding: 0;">
            {% for chapter in object.chapters.all %}
            <li class="chapter-item" data-chapter-id="{{ chapter.id }}"
                style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;">
                {% if request.user == story.author %}
                <span class="drag-handle" style="cursor: move; margin-right: 10px;">⋮⋮</span>
                {% endif %}
                <a href="{% url 'chapter-detail' object.id chapter.number %}">
                    Chapter {{ chapter.number }}: {{ chapter.title }}
                </a>
            </li>
            {% empty %}
            <li>No chapters yet.</li>
            {% endfor %}
        </ul>

        {% if request.user == story.author %}
        <div class="mt-3">
            <a class="btn btn-secondary btn-sm" href="{% url 'add-chapter' story.id %}">Add New Chapter</a>

        </div>
        {% endif %}
    </div>
</article>


<style>
.sortable-ghost {
    opacity: 0.4;
}
</style>

<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{% static 'stories/js/chapter_reorder.js' %}"></script>



{% endblock content %}


{% block sidebar %}
<div class="content-section">

    <div><img class="rounded-circle article-img" src="{{ object.author.profile.get_image_url }}"></div>
    <p class="article-summary">Author: <a class="mr-2" href="{% url 'user-stories' story.author.username %}">
            {{ object.author }}</a></p>
    <p class="article-date-published">Date published: {{ object.date_published|date:'dS, F, Y' }}</p>

    <p class="article-title">Title: {{ object.title }}</p>
    <p class="article-summary">Summary: {{ object.summary }}</p>
    <p class="article-genre">Genre: {{ object.genre }}</p>
    <p class="article-genre">Fandom: {{ object.fandom }}</p>
    {% if object.author == user %}
    <div>
        <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'story-update' object.id %}">Edit story</a>
        <!-- Changed here -->
        <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'story-delete' object.id %}">Delete story</a>
        <!-- Changed here -->
    </div>
    {% endif %}

    {% if user.is_authenticated and user != object.author %}
    <a href="{% url 'mails:compose' %}?to={{ story.author.username }}&story={{ story.title }}" class="btn btn-primary">
        Message the author
    </a>
    {% endif %}
</div>



{% endblock %}